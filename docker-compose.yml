version: "3.9"

services:
  # ─── Shared PostgreSQL ─────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ─── Code Parser (port 8000) ───────────────────────────────────────
  code-parser:
    build:
      context: ./services/code-parser
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/code_parser
      DEBUG: "false"
      LOG_LEVEL: INFO
      WORKER_COUNT: "4"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - /tmp/codecircle-repos:/repos:ro

  # ─── Metrics Explorer (port 8001) ──────────────────────────────────
  metrics-explorer:
    build:
      context: ./services/metrics-explorer
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/metrics_explorer
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
      PORT: "8001"
      HOST: "0.0.0.0"
      APP_ENV: production
      LOG_LEVEL: INFO
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001"]

  # ─── Logs Explorer (port 8003) ─────────────────────────────────────
  logs-explorer:
    build:
      context: ./services/logs-explorer/backend
      dockerfile: ../Dockerfile.logs
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/logs_explorer
      APP_PORT: "8003"
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy

  # ─── FixAI Agent (port 8100) ───────────────────────────────────────
  fixai:
    build:
      context: ./services/fixai/backend
      dockerfile: ../Dockerfile.fixai
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/fixai
      CODE_PARSER_BASE_URL: http://code-parser:8000
      METRICS_EXPLORER_BASE_URL: http://metrics-explorer:8001
      LOGS_EXPLORER_BASE_URL: http://logs-explorer:8003
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      CLAUDE_BEDROCK_URL: ${CLAUDE_BEDROCK_URL:-}
      CLAUDE_MODEL_ID: ${CLAUDE_MODEL_ID:-anthropic.claude-sonnet-4-20250514-v1:0}
      CLAUDE_MAX_TOKENS: "4096"
      APP_ENV: production
      LOG_LEVEL: INFO
      APP_PORT: "8100"
    ports:
      - "8100:8100"
    depends_on:
      postgres:
        condition: service_healthy
      code-parser:
        condition: service_started
      metrics-explorer:
        condition: service_started
      logs-explorer:
        condition: service_started

  # ─── CodeCircle Platform API (port 8200) ───────────────────────────
  platform:
    build:
      context: ./platform
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/codecircle
      FIXAI_URL: http://fixai:8100
      METRICS_EXPLORER_URL: http://metrics-explorer:8001
      LOGS_EXPLORER_URL: http://logs-explorer:8003
      CODE_PARSER_URL: http://code-parser:8000
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
    ports:
      - "8200:8200"
    depends_on:
      postgres:
        condition: service_healthy
      fixai:
        condition: service_started

  # ─── Dashboard (port 5173) ─────────────────────────────────────────
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - platform
      - fixai

volumes:
  pgdata:
